---
# Copyright (c) Ansible Project
# GNU General Public License v3.0+ (see LICENSES/GPL-3.0-or-later.txt or https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later
- environment:
    AWS_ACCESS_KEY_ID: "{{ aws_access_key | default(omit) }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_secret_key | default(omit) }}"
    AWS_SESSION_TOKEN: "{{ security_token | default(omit) }}"
    AWS_REGION: "{{ aws_region | default(omit) }}"
  block:
    - name: create temporary directory for project path
      tempfile:
        state: directory
        suffix: .project
      register: _terraform_path

    - set_fact:
        terraform_project_path: "{{ _terraform_path.path }}"
    
    - name: copy project files into project path
      copy:
        dest: "{{ terraform_project_path }}"
        src: "{{ item }}"
      with_items:
        - cloud.tf

    - include_tasks: terraform_aws_run.yaml
      with_items:
        # Present -> apply with check_mode
        - check_mode: true
          state: present
          changed: true
          nbkeys: 0
        # Present -> apply without check_mode
        - check_mode: false
          state: present
          changed: true
          nbkeys: 1
        # Present -> apply idempotency
        - check_mode: false
          state: present
          changed: false
          nbkeys: 1
        # absent -> destroy with check_mode
        - check_mode: true
          state: absent
          changed: true
          nbkeys: 1
        # absent -> destroy without check_mode
        - check_mode: false
          state: absent
          changed: true
          nbkeys: 0
        # absent -> destroy idempotency
        - check_mode: false
          state: absent
          changed: false
          nbkeys: 0

  always:
    - name: Remove key pair
      amazon.aws.ec2_key:
        name: "{{ key_pair_name }}"
        state: absent
      ignore_errors: true

    - name: Remove temporary directory used for test
      file:
        state: absent
        path: "{{ terraform_project_path }}"
      ignore_errors: true